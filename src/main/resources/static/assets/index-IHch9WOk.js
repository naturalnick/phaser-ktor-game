var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{p as s}from"./phaser-DM0uoNMb.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class i extends s.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.scene.start("Preloader")}}class a extends s.Scene{constructor(){super({key:"FadeTransition"})}create({targetScene:e,targetMap:t,playerPosition:s,fadeColor:i=0,duration:a=500}){const n=this.add.rectangle(0,0,this.scale.width,this.scale.height,i);n.setOrigin(0,0),n.setAlpha(0),this.tweens.add({targets:n,alpha:1,duration:a/2,onComplete:()=>{this.scene.start(e,{targetMap:t,playerPosition:s}),this.tweens.add({targets:n,alpha:0,duration:a/2,onComplete:()=>{this.scene.remove(this)}})}})}}class n{constructor(e,s){t(this,"scene"),t(this,"mainCamera"),t(this,"target",null),this.scene=e,this.mainCamera=e.cameras.main,this.setupCamera(s)}setupCamera(e){if(null==e?void 0:e.bounds){const t=Math.max(0,(this.scene.scale.width-e.bounds.width)/2),s=Math.max(0,(this.scene.scale.height-e.bounds.height)/2);this.mainCamera.setBounds(0,0,e.bounds.width,e.bounds.height),this.mainCamera.setViewport(t,s,Math.min(this.scene.scale.width,e.bounds.width),Math.min(this.scene.scale.height,e.bounds.height))}(null==e?void 0:e.deadzone)&&this.mainCamera.setDeadzone(e.deadzone.width,e.deadzone.height),(null==e?void 0:e.lerp)&&this.mainCamera.setLerp(e.lerp)}startFollow(e){this.target=e,this.mainCamera.startFollow(e)}stopFollow(){this.target=null,this.mainCamera.stopFollow()}shake(e,t=.05){this.mainCamera.shake(e,t)}fade(e=1e3,t=0){return new Promise((s=>{this.mainCamera.fadeOut(e,t),this.mainCamera.once("camerafadeoutcomplete",s)}))}fadeIn(e=1e3,t=0){return new Promise((s=>{this.mainCamera.fadeIn(e,t),this.mainCamera.once("camerafadeincomplete",s)}))}}class r{constructor(e,s,i){var a;t(this,"sprite"),t(this,"cursors"),t(this,"scene"),this.scene=e,this.sprite=e.physics.add.sprite(s,i,"player"),this.sprite.setCollideWorldBounds(!0);const n=null==(a=e.input.keyboard)?void 0:a.createCursorKeys();n&&(this.cursors=n),this.createAnimations()}createAnimations(){this.scene.anims.exists("left")||this.scene.anims.create({key:"left",frames:this.scene.anims.generateFrameNumbers("player",{start:0,end:3}),frameRate:10,repeat:-1}),this.scene.anims.exists("turn")||this.scene.anims.create({key:"turn",frames:[{key:"player",frame:4}],frameRate:20}),this.scene.anims.exists("right")||this.scene.anims.create({key:"right",frames:this.scene.anims.generateFrameNumbers("player",{start:5,end:8}),frameRate:10,repeat:-1})}update(){this.cursors&&this.sprite.body&&(this.cursors.left.isDown?(this.sprite.setVelocityX(-160),this.sprite.anims.play("left",!0)):this.cursors.right.isDown?(this.sprite.setVelocityX(160),this.sprite.anims.play("right",!0)):(this.sprite.setVelocityX(0),this.sprite.anims.play("turn")),this.cursors.up.isDown?this.sprite.setVelocityY(-160):this.cursors.down.isDown?this.sprite.setVelocityY(160):this.sprite.setVelocityY(0))}getSprite(){return this.sprite}getVelocity(){var e;return(null==(e=this.sprite.body)?void 0:e.velocity)??new Phaser.Math.Vector2}}class h{constructor(e){t(this,"scene"),t(this,"container"),this.scene=e,this.container=this.scene.add.container(0,0)}getContainer(){return this.container}}class o extends h{constructor(e,s,i){super(e),t(this,"background"),t(this,"messagesText"),t(this,"inputBox"),t(this,"inputText"),t(this,"messages",[]),t(this,"config"),t(this,"isInputActive",!1),t(this,"currentInput",""),t(this,"webSocketService"),this.webSocketService=i,this.config={maxMessages:50,fontSize:16,padding:10,x:10,y:e.scale.height-s.height-10,...s},this.createChatUI(),this.setupInputHandling(),this.webSocketService.onChatMessage(((e,t)=>{this.addMessage(`Player ${e}: ${t}`)}))}createChatUI(){this.container.setPosition(this.config.x,this.config.y),this.background=this.scene.add.rectangle(0,0,this.config.width,this.config.height,0,.5).setOrigin(0,0),this.messagesText=this.scene.add.text(this.config.padding,this.config.padding,"",{fontSize:`${this.config.fontSize}px`,color:"#ffffff",wordWrap:{width:this.config.width-2*this.config.padding}}).setOrigin(0,0),this.inputBox=this.scene.add.rectangle(0,this.config.height-30,this.config.width,30,3355443).setOrigin(0,0),this.inputText=this.scene.add.text(this.config.padding,this.config.height-25,"",{fontSize:`${this.config.fontSize}px`,color:"#ffffff"}).setOrigin(0,0),this.container.add([this.background,this.messagesText,this.inputBox,this.inputText]),this.inputBox.setInteractive({useHandCursor:!0}).on("pointerdown",(()=>{this.activateInput()}))}setupInputHandling(){var e;null==(e=this.scene.input.keyboard)||e.on("keydown",(e=>{this.isInputActive&&("Enter"===e.key?this.sendMessage():"Escape"===e.key?this.deactivateInput():"Backspace"===e.key?(this.currentInput=this.currentInput.slice(0,-1),this.updateInputText()):1===e.key.length&&(this.currentInput+=e.key,this.updateInputText()))}))}activateInput(){this.isInputActive=!0,this.inputBox.setFillStyle(4473924)}deactivateInput(){this.isInputActive=!1,this.currentInput="",this.updateInputText(),this.inputBox.setFillStyle(3355443)}updateInputText(){this.inputText.setText(this.currentInput)}sendMessage(){if(this.currentInput.trim()){const e=this.scene.data.get("currentMapId")||"map5";console.log(e),this.webSocketService.sendMessage(this.currentInput,e),this.addMessage(`You: ${this.currentInput}`),this.currentInput="",this.updateInputText()}this.deactivateInput()}addMessage(e){this.messages.push(e),this.messages.length>this.config.maxMessages&&this.messages.shift(),this.updateMessages()}updateMessages(){this.messagesText.setText(this.messages.join("\n"))}handleResize(e){this.container.setPosition(this.config.x,e.height-this.config.height-10)}destroy(){var e;this.container.destroy(),null==(e=this.scene.input.keyboard)||e.off("keydown")}}class c{constructor(e,s,i,a,n,r){t(this,"scene"),t(this,"trigger"),t(this,"transitionData"),t(this,"isTransitioning",!1),this.scene=e,this.transitionData=r,this.trigger=e.add.zone(s,i,a,n),e.physics.world.enable(this.trigger);const h=this.trigger.body;h.setAllowGravity(!1),h.moves=!1}addOverlapWith(e,t){this.scene.physics.add.overlap(e,this.trigger,(()=>{this.isTransitioning||(this.isTransitioning=!0,this.handleTransition(t))}),void 0,this)}handleTransition(e){this.scene.scene.launch("FadeTransition",{targetScene:"Game",targetMap:this.transitionData.targetMap,playerPosition:this.transitionData.playerPosition,fadeColor:this.transitionData.fadeColor,duration:this.transitionData.duration}),e&&e()}}class l{constructor(e){t(this,"scene"),t(this,"transitions",[]),this.scene=e}loadFromTiledLayer(e){console.log("Loading transitions from layer:",e);for(const t of e.objects){const e=t,s=this.parseTransitionProperties(e);if(s){const t=new c(this.scene,e.x+e.width/2,e.y+e.height/2,e.width,e.height,s);this.transitions.push(t)}}}parseTransitionProperties(e){if(!e.properties)return null;const t=t=>{var s;const i=null==(s=e.properties)?void 0:s.find((e=>e.name===t));return i?i.value:void 0},s=t("targetMap"),i=t("targetX"),a=t("targetY"),n=t("fadeColor")||0,r=t("duration")||500;return s&&void 0!==i&&void 0!==a?{targetMap:s,playerPosition:{x:i,y:a},fadeColor:n,duration:r}:(console.warn("Transition object missing required properties:",e),null)}setupPlayerTransitions(e){this.transitions.forEach((t=>{t.addOverlapWith(e)}))}destroy(){this.transitions=[]}}class d{constructor(e){t(this,"scene"),t(this,"map"),t(this,"tilesets"),t(this,"layers"),t(this,"transitionManager"),t(this,"currentMapId"),t(this,"isLoading"),this.scene=e,this.map=null,this.tilesets=new Map,this.layers=new Map,this.transitionManager=new l(e),this.currentMapId=null,this.isLoading=!1}preload(){this.scene.load.image("tiles","assets/tilesets/rpg_tileset.png"),this.scene.load.image("tiles2","assets/tilesets/hyptosis_tiles_1.png")}async loadMap(e){if(this.isLoading)throw new Error("Map is already loading");try{if(this.isLoading=!0,this.destroy(),this.scene.cache.tilemap.exists(e)||(this.scene.load.tilemapTiledJSON(e,`assets/maps/${e}.tmj`),await new Promise((e=>{this.scene.load.once("complete",(()=>e())),this.scene.load.start()}))),this.map=this.scene.make.tilemap({key:e}),!this.map)throw new Error("Failed to create tilemap");const t=this.map.addTilesetImage("Ground","tiles"),s=this.map.addTilesetImage("hyptosis_tiles_1","tiles2");if(!t||!s)throw new Error("Failed to load tilesets");const i=this.map.createLayer("Tile Layer 1",[t,s],0,0);i&&(i.setCollisionByProperty({collides:!0}),this.layers.set("Tile Layer 1",i)),await this.loadTransitions(),this.currentMapId=e}catch(t){throw this.destroy(),console.error("Error loading map:",t),t}finally{this.isLoading=!1}}getLayer(e){return this.layers.get(e)}getLayers(){return this.layers}getCollisionLayers(){return Array.from(this.layers.values()).filter((e=>e.collisionMask))}async loadTransitions(){if(!this.map)return;const e=this.map.getObjectLayer("Transitions");e&&this.transitionManager.loadFromTiledLayer(e)}setupPlayerTransitions(e){this.transitionManager.setupPlayerTransitions(e)}getCurrentMapId(){return this.currentMapId}getMapBounds(){return this.map?{width:this.map.widthInPixels,height:this.map.heightInPixels}:null}destroy(){this.layers.forEach((e=>e.destroy())),this.layers.clear(),this.tilesets.clear(),this.map&&this.map.destroy(),this.map=null,this.currentMapId=null}}class p{constructor(e){t(this,"scene"),t(this,"uiCamera"),t(this,"uiContainer"),this.scene=e,this.uiContainer=this.scene.add.container(0,0),this.uiContainer.setScrollFactor(0),this.uiCamera=this.scene.cameras.add(0,0,e.scale.width,e.scale.height),this.uiCamera.setName("uiCamera"),this.uiCamera.ignore(this.scene.children.list.filter((e=>e!==this.uiContainer&&(Phaser.GameObjects.Sprite,!0)))),this.scene.cameras.main.ignore([this.uiContainer]),this.scene.scale.on("resize",this.handleResize,this)}handleResize(e){this.uiCamera.setViewport(0,0,e.width,e.height)}getUIContainer(){return this.uiContainer}getUICamera(){return this.uiCamera}updateIgnoreList(){this.uiCamera.ignore(this.scene.children.list.filter((e=>e!==this.uiContainer&&(Phaser.GameObjects.Sprite,!0))))}destroy(){this.uiCamera.destroy(),this.uiContainer.destroy(),this.scene.scale.off("resize",this.handleResize)}}class g{constructor(e,s){t(this,"socket"),t(this,"scene"),t(this,"otherPlayers"),t(this,"messageHandlers",[]),t(this,"uiManager"),this.scene=e,this.otherPlayers=new Map;const i=Math.floor(100*Math.random()).toString();this.socket=new WebSocket(`ws://localhost:8080/game?id=${i}`),this.setupSocketListeners(),this.uiManager=s}setupSocketListeners(){this.socket.onmessage=e=>{const[t,s,...i]=e.data.split("|");switch(console.log(t,s,...i),t){case"join":this.handlePlayerJoin(s,parseFloat(i[0]),parseFloat(i[1]));break;case"chat":this.handleChatMessage(s,i[0]);break;case"move":this.handlePlayerMove(s,parseFloat(i[0]),parseFloat(i[1]));break;case"leave":this.handlePlayerLeave(s)}}}handlePlayerJoin(e,t,s){if(!this.otherPlayers.has(e)){const i=new r(this.scene,t,s);this.otherPlayers.set(e,i.getSprite()),this.uiManager.updateIgnoreList()}}handlePlayerMove(e,t,s){if(!this.otherPlayers.has(e))return void this.handlePlayerJoin(e,t,s);const i=this.otherPlayers.get(e);i&&this.scene.tweens.add({targets:i,x:t,y:s,duration:100,ease:"Linear"})}handlePlayerLeave(e){const t=this.otherPlayers.get(e);t&&(t.destroy(),this.otherPlayers.delete(e))}handleChatMessage(e,t){this.messageHandlers.forEach((s=>s(e,t)))}onChatMessage(e){this.messageHandlers.push(e)}offChatMessage(e){const t=this.messageHandlers.indexOf(e);t>-1&&this.messageHandlers.splice(t,1)}sendPosition(e,t,s){this.socket.readyState===WebSocket.OPEN&&this.socket.send(`move|${e}|${t}|${s}`)}sendMessage(e,t){this.socket.readyState===WebSocket.OPEN&&(console.log("sending chat socket"),this.socket.send(`chat|${e}|${t}`))}initializeConnection(e,t,s){this.socket.readyState===WebSocket.OPEN?this.socket.send(`join|${e}|${t}|${s}`):this.socket.onopen=()=>{console.log("sending join"),this.socket.send(`join|${e}|${t}|${s}`)}}destroy(){this.socket.close(),this.otherPlayers.forEach((e=>e.destroy())),this.otherPlayers.clear(),this.messageHandlers=[]}}class u extends s.Scene{constructor(){super("Game"),t(this,"webSocketService"),t(this,"cameraController"),t(this,"mapManager"),t(this,"player"),t(this,"uiManager"),t(this,"chatUI")}preload(){this.load.spritesheet("player","https://labs.phaser.io/assets/sprites/dude.png",{frameWidth:32,frameHeight:48}),this.mapManager=new d(this),this.mapManager.preload()}async create(){const e=this.scene.settings.data;await this.mapManager.loadMap((null==e?void 0:e.targetMap)||"map5");const t=this.mapManager.getMapBounds();if(t){const s=(null==e?void 0:e.playerPosition)||{x:this.scale.width<t.width?this.scale.width/2:t.width/2,y:this.scale.height<t.height?this.scale.height/2:t.height/2};this.player=new r(this,s.x,s.y),this.uiManager=new p(this),this.webSocketService=new g(this,this.uiManager),this.webSocketService.initializeConnection(s.x,s.y,"map5"),this.chatUI=new o(this,{width:Math.min(300,.3*this.scale.width),height:Math.min(200,.3*this.scale.height)},this.webSocketService),this.uiManager.getUIContainer().add(this.chatUI.getContainer()),this.mapManager.setupPlayerTransitions(this.player.getSprite()),this.mapManager.getCollisionLayers().forEach((e=>{this.physics.add.collider(this.player.getSprite(),e)}));const i={lerp:.1,bounds:{x:0,y:0,width:t.width,height:t.height}};this.cameraController=new n(this,i),this.cameraController.startFollow(this.player.getSprite()),this.scale.on("resize",(e=>{this.cameraController.setupCamera(i),this.chatUI.handleResize(e)})),this.physics.world.setBounds(-32,-32,t.width+64,t.height+64)}}update(){var e;if(null==(e=this.player)||e.update(),this.player&&(0!==this.player.getVelocity().x||0!==this.player.getVelocity().y)){const e=this.player.getSprite();console.log(e.x,e.y),this.webSocketService.sendPosition(e.x,e.y,this.mapManager.getCurrentMapId())}}destroy(){var e;null==(e=this.webSocketService)||e.destroy()}}class m extends s.Scene{constructor(){super("GameOver"),t(this,"camera"),t(this,"background"),t(this,"gameover_text")}create(){this.camera=this.cameras.main,this.camera.setBackgroundColor(16711680),this.background=this.add.image(512,384,"background"),this.background.setAlpha(.5),this.gameover_text=this.add.text(512,384,"Game Over",{fontFamily:"Arial Black",fontSize:64,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}),this.gameover_text.setOrigin(.5),this.input.once("pointerdown",(()=>{this.scene.start("MainMenu")}))}}class y extends s.Scene{constructor(){super("MainMenu"),t(this,"title")}create(){this.title=this.add.text(this.scale.width/2,this.scale.height/2,"Main Menu",{fontFamily:"Arial Black",fontSize:38,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5),this.scene.start("Game")}}class f extends s.Scene{constructor(){super("Preloader")}init(){this.add.image(512,384,"background"),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const e=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",(t=>{e.width=4+460*t}))}preload(){this.load.setPath("assets"),this.load.image("logo","logo.png")}create(){this.scene.start("MainMenu")}}const w={type:Phaser.AUTO,parent:"game-container",backgroundColor:"#000",pixelArt:!0,width:window.innerWidth,height:window.innerHeight,scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!0}},scene:[i,f,y,u,a,m]};new s.Game(w);
